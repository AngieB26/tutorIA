generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Estudiante {
  id                   String                    @id @default(uuid())
  nombre               String?                   // Campo calculado para compatibilidad
  nombres              String                    // Campo principal
  apellidos            String                    // Campo principal
  grado                String
  seccion              String
  edad                 Int?
  fechaNacimiento      String?
  fotoPerfil           String?
  contactoTelefono     String?
  contactoEmail        String?
  contactoNombre       String?
  tutorNombre          String?
  tutorTelefono        String?
  tutorEmail           String?
  apoderadoNombre      String?
  apoderadoParentesco  String?
  apoderadoTelefono    String?
  apoderadoTelefonoAlt String?
  apoderadoEmail       String?
  apoderadoDireccion   String?
  asistencias          Int?                      @default(0)
  ausencias            Int?                      @default(0)
  tardanzas            Int?                      @default(0)
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt
  incidencias          Incidencia[]              @relation("EstudianteIncidencias")
  notas                Nota[]                    @relation("EstudianteNotas")
  asistenciasRegistro  RegistroAsistenciaEntry[] @relation("EstudianteAsistencias")

  @@index([grado, seccion])
  @@index([nombre])
  @@index([nombres, apellidos])
}

model Tutor {
  id           String              @id @default(uuid())
  nombre       String
  email        String?
  telefono     String?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  clases       Clase[]
  incidencias  Incidencia[]
  asignaciones TutorGradoSeccion[]

  @@index([nombre])
}

model TutorGradoSeccion {
  id        String   @id @default(uuid())
  grado     String
  seccion   String
  tutorId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tutor     Tutor    @relation(fields: [tutorId], references: [id], onDelete: Cascade)

  @@unique([grado, seccion])
  @@index([grado, seccion])
  @@index([tutorId])
}

model Incidencia {
  id              String      @id @default(uuid())
  studentName     String
  estudianteId    String?
  tipo            String
  subtipo         String?
  gravedad        String
  descripcion     String
  fecha           String
  profesor        String
  profesorId      String?
  tutorNombre     String?
  lugar           String?
  timestamp       BigInt
  derivacion      String?
  resuelta        Boolean     @default(false)
  fechaResolucion String?
  resueltaPor     String?
  estado          String      @default("Pendiente")
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  historialEstado String?
  estudiante      Estudiante? @relation("EstudianteIncidencias", fields: [estudianteId], references: [id])
  tutor           Tutor?      @relation(fields: [profesorId], references: [id])

  @@index([studentName])
  @@index([estudianteId])
  @@index([fecha])
  @@index([tipo])
  @@index([gravedad])
  @@index([estado])
  @@index([profesorId])
}

model Nota {
  id           String      @id @default(uuid())
  studentName  String
  estudianteId String?
  materia      String
  nota         Float
  fecha        String
  profesor     String
  comentario   String?
  estado       String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  estudiante   Estudiante? @relation("EstudianteNotas", fields: [estudianteId], references: [id])

  @@index([studentName])
  @@index([estudianteId])
  @@index([fecha])
  @@index([materia])
}

model Clase {
  id                  String                    @id @default(uuid())
  nombre              String
  grado               String
  seccion             String
  profesor            String
  profesorId          String?
  dias                String
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  tutor               Tutor?                    @relation(fields: [profesorId], references: [id])
  registrosAsistencia RegistroAsistenciaClase[]

  @@index([grado, seccion])
  @@index([profesorId])
}

model RegistroAsistenciaClase {
  id        String                    @id @default(uuid())
  fecha     String
  dia       String
  claseId   String
  grado     String
  seccion   String
  profesor  String
  periodo   Int
  lugar     String?
  timestamp BigInt
  createdAt DateTime                  @default(now())
  updatedAt DateTime                  @updatedAt
  clase     Clase                     @relation(fields: [claseId], references: [id], onDelete: Cascade)
  entries   RegistroAsistenciaEntry[]

  @@unique([fecha, claseId, periodo])
  @@index([fecha])
  @@index([claseId])
  @@index([grado, seccion])
}

model RegistroAsistenciaEntry {
  id                   String                  @id @default(uuid())
  registroAsistenciaId String
  studentName          String
  estudianteId         String?
  estado               String
  createdAt            DateTime                @default(now())
  estudiante           Estudiante?             @relation("EstudianteAsistencias", fields: [estudianteId], references: [id])
  registroAsistencia   RegistroAsistenciaClase @relation(fields: [registroAsistenciaId], references: [id], onDelete: Cascade)

  @@unique([registroAsistenciaId, studentName])
  @@index([studentName])
  @@index([estudianteId])
}

model Grado {
  id        String   @id @default(uuid())
  nombre    String   @unique
  createdAt DateTime @default(now())
}

model Seccion {
  id        String   @id @default(uuid())
  nombre    String   @unique
  createdAt DateTime @default(now())
}
